<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parata Air Operation Tech Team - Accounting System</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #334155; }
        .sidebar { background: #0f172a; color: white; transition: all 0.3s; }
        .nav-item:hover { background: #1e293b; color: #38bdf8; }
        .nav-item.active { background: #1e293b; color: #38bdf8; border-right: 3px solid #38bdf8; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #0ea5e9; color: white; transition: background 0.2s; }
        .btn-primary:hover { background-color: #0284c7; }
        .status-paid { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fee2e2; color: #991b1b; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }

        /* Chart Container */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 300px;
        }

        /* Custom Scrollbar for Table */
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <!-- Placeholder Comments -->
    <!-- Chosen Palette: Slate & Sky Blue (Professional, Clean, Trustworthy for Accounting) -->
    <!-- Application Structure Plan: 
         1. Sidebar Navigation: Persistent access to main modules (Dashboard, Invoices, Analytics).
         2. Dashboard Header: Global filters (Year/Month) that affect ALL summary cards and charts instantly.
         3. Summary Cards: Key metrics (Total Spend, Pending) updated by filters.
         4. Main Content Area: 
            - Dynamic View Switcher for the Invoice List (List vs Vendor Group vs Month Group).
            - Edit Modal for direct data manipulation.
         This structure allows the user to drill down from high-level yearly totals to specific invoice line items effortlessly.
    -->
    <!-- Visualization & Content Choices:
         - Summary Cards: Immediate financial health check.
         - Line Chart: Monthly spending trends to identify spikes.
         - Doughnut Chart: Vendor share analysis to see where money is going.
         - Interactive Table: Sortable, filterable, editable list for detailed management.
         - Grouped Views: Accordion-style layout for Vendor/Month views to reduce cognitive load.
    -->
    <!-- CONFIRMATION: NO SVG graphics used (FontAwesome used for icons). NO Mermaid JS used. -->
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <!-- Sidebar -->
    <aside class="sidebar w-64 flex-shrink-0 flex flex-col hidden md:flex">
        <div class="p-6 border-b border-gray-800">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <i class="fas fa-plane-departure text-sky-400"></i>
                <span>PARATA <span class="text-sky-400">OPS</span></span>
            </h1>
            <p class="text-xs text-gray-400 mt-1">Accounting Management</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <a href="#" onclick="switchTab('dashboard')" class="nav-item active flex items-center px-6 py-3 cursor-pointer">
                <i class="fas fa-chart-pie w-6"></i>
                <span>대시보드</span>
            </a>
            <a href="#" onclick="switchTab('invoices')" class="nav-item flex items-center px-6 py-3 cursor-pointer">
                <i class="fas fa-file-invoice-dollar w-6"></i>
                <span>지출 내역 관리</span>
            </a>
            <a href="#" onclick="switchTab('vendors')" class="nav-item flex items-center px-6 py-3 cursor-pointer">
                <i class="fas fa-building w-6"></i>
                <span>업체 관리</span>
            </a>
            <a href="#" onclick="alert('보고서 생성 기능 준비중')" class="nav-item flex items-center px-6 py-3 cursor-pointer">
                <i class="fas fa-print w-6"></i>
                <span>보고서 출력</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-sky-500 flex items-center justify-center font-bold">P</div>
                <div>
                    <p class="text-sm font-medium">Park Namjun</p>
                    <p class="text-xs text-gray-500">Administrator</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Top Header & Global Filter -->
        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-gray-600"><i class="fas fa-bars"></i></button>
                <h2 class="text-lg font-bold text-gray-800" id="pageTitle">운항기술팀 회계 현황</h2>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Global Date Filter for Summary -->
                <div class="flex items-center bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                    <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
                    <select id="globalPeriodFilter" class="bg-transparent text-sm font-medium focus:outline-none text-gray-600" onchange="updateDashboard()">
                        <option value="all">전체 기간</option>
                        <option value="2025" selected>2025년</option>
                        <option value="2024">2024년</option>
                    </select>
                </div>
                
                <div id="monthFilterContainer" class="hidden flex items-center bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200 ml-2">
                    <select id="globalMonthFilter" class="bg-transparent text-sm font-medium focus:outline-none text-gray-600" onchange="updateDashboard()">
                        <option value="all">전체 월</option>
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6">6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                </div>

                <button onclick="document.getElementById('addInvoiceModal').classList.remove('hidden')" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2">
                    <i class="fas fa-plus"></i> <span>지출 등록</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50" id="mainScrollArea">
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-5 border-l-4 border-sky-500">
                    <p class="text-gray-500 text-xs font-semibold uppercase mb-1">총 지출 금액 (USD)</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="summaryTotalUSD">$0.00</h3>
                    <p class="text-xs text-green-600 mt-1 flex items-center"><i class="fas fa-arrow-up mr-1"></i> <span id="summaryTotalKRW">₩0</span> (KRW 환산)</p>
                </div>
                <div class="card p-5 border-l-4 border-indigo-500">
                    <p class="text-gray-500 text-xs font-semibold uppercase mb-1">결제 완료</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="summaryPaid">$0.00</h3>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                        <div class="bg-indigo-500 h-1.5 rounded-full" id="paidProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="card p-5 border-l-4 border-rose-500">
                    <p class="text-gray-500 text-xs font-semibold uppercase mb-1">미지급 (Pending)</p>
                    <h3 class="text-2xl font-bold text-rose-600" id="summaryPending">$0.00</h3>
                    <p class="text-xs text-gray-500 mt-1" id="pendingCount">0건 처리 대기중</p>
                </div>
                <div class="card p-5 border-l-4 border-amber-500">
                    <p class="text-gray-500 text-xs font-semibold uppercase mb-1">이번 달 예상</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="summaryThisMonth">$0.00</h3>
                    <p class="text-xs text-gray-500 mt-1">전월 대비 변동폭</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">월별 지출 추이</h3>
                        <div class="text-xs text-gray-400">최근 12개월</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">업체별 비중</h3>
                        <button class="text-xs text-sky-500 hover:underline">상세보기</button>
                    </div>
                    <div class="chart-container flex justify-center">
                        <canvas id="vendorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Invoice Management Section -->
            <div class="card flex flex-col">
                <div class="p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 class="font-bold text-lg text-gray-800">지출 내역 리스트</h3>
                    
                    <!-- View Options Controls -->
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="setListView('table')" id="btnViewTable" class="px-3 py-1.5 rounded-md text-xs font-medium bg-white shadow-sm text-gray-800 transition-all">전체 목록</button>
                        <button onclick="setListView('vendor')" id="btnViewVendor" class="px-3 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-800 transition-all">업체별 보기</button>
                        <button onclick="setListView('month')" id="btnViewMonth" class="px-3 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-800 transition-all">월별 보기</button>
                    </div>

                    <div class="flex gap-2 w-full md:w-auto">
                        <div class="relative w-full md:w-64">
                            <input type="text" id="searchInput" placeholder="Search invoices..." class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500" onkeyup="renderInvoiceList()">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                        <button onclick="exportToExcel()" class="btn-primary px-3 rounded-lg text-xs md:text-sm whitespace-nowrap">
                            <i class="fas fa-file-excel mr-1"></i> 엑셀 저장
                        </button>
                    </div>
                </div>
                
                <!-- Table View -->
                <div id="viewTable" class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                <th class="p-4 font-medium border-b">날짜</th>
                                <th class="p-4 font-medium border-b">Invoice No.</th>
                                <th class="p-4 font-medium border-b">업체 (Vendor)</th>
                                <th class="p-4 font-medium border-b">내역 (Description)</th>
                                <th class="p-4 font-medium border-b text-right">금액 (USD)</th>
                                <th class="p-4 font-medium border-b text-center">상태</th>
                                <th class="p-4 font-medium border-b text-center">관리</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody" class="text-sm divide-y divide-gray-100">
                            <!-- Rows rendered by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Grouped Views Container -->
                <div id="viewGrouped" class="hidden p-4 space-y-4">
                    <!-- Dynamic grouped content rendered here -->
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-lg flex justify-between items-center text-xs text-gray-500">
                    <span id="recordCount">Total 0 records</span>
                    <div class="flex gap-1">
                        <button class="px-2 py-1 rounded hover:bg-gray-200 disabled:opacity-50"><i class="fas fa-chevron-left"></i></button>
                        <button class="px-2 py-1 rounded bg-white shadow-sm font-bold text-sky-600">1</button>
                        <button class="px-2 py-1 rounded hover:bg-gray-200 disabled:opacity-50"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-8 text-center text-xs text-gray-400 pb-4">
                <p>&copy; 2026 Parata Air Operation Tech Team. All rights reserved.</p>
            </footer>
        </div>
    </main>

    <!-- Modals -->
    
    <!-- Add/Edit Invoice Modal -->
    <div id="addInvoiceModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-sky-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-edit text-sky-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">지출 내역 등록/수정</h3>
                            <div class="mt-4 grid grid-cols-1 gap-y-4 gap-x-4">
                                <input type="hidden" id="editIndex">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">날짜 (Date)</label>
                                        <input type="date" id="inputDate" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Invoice No.</label>
                                        <input type="text" id="inputInvoiceNo" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">업체 (Vendor)</label>
                                    <select id="inputVendor" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500">
                                        <option value="Airbus">Airbus</option>
                                        <option value="Honeywell">Honeywell</option>
                                        <option value="Jeppesen">Jeppesen</option>
                                        <option value="Navblue">Navblue</option>
                                        <option value="Other">기타 (직접입력)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">내역 (Description)</label>
                                    <input type="text" id="inputDesc" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">금액 (USD)</label>
                                        <input type="number" id="inputAmount" step="0.01" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">상태</label>
                                        <select id="inputStatus" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500">
                                            <option value="Pending">미지급 (Pending)</option>
                                            <option value="Paid">지급 완료 (Paid)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveInvoice()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        저장하기
                    </button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // Data Store (Simulated DB based on uploaded PDFs)
        let invoices = [
            { id: 1, date: '2025-06-25', invoiceNo: '1518409', vendor: 'Airbus', desc: 'A320 Technical Data Package', amount: 2873.33, status: 'Pending', currency: 'USD' },
            { id: 2, date: '2025-03-11', invoiceNo: '1511372', vendor: 'Airbus', desc: 'Basic PEP Package', amount: 3716.67, status: 'Paid', currency: 'USD' },
            { id: 3, date: '2025-10-23', invoiceNo: 'A30EA49955', vendor: 'Honeywell', desc: 'Nav Database Renewal (Cycle 2513-2602)', amount: 22632.69, status: 'Pending', currency: 'USD' },
            { id: 4, date: '2025-07-01', invoiceNo: '81410867', vendor: 'Navblue', desc: 'Flysmart+ Gateway iOS Hosting', amount: 66636.70, status: 'Pending', currency: 'USD' },
            { id: 5, date: '2025-12-01', invoiceNo: '460046163', vendor: 'Jeppesen', desc: 'NavData Service Subscription', amount: 5420.00, status: 'Pending', currency: 'EUR' }, // Estimated amount converted or raw
            { id: 6, date: '2025-02-07', invoiceNo: '450068221', vendor: 'Jeppesen', desc: 'FD Pro Aviator Software', amount: 3200.00, status: 'Paid', currency: 'USD' },
            { id: 7, date: '2024-12-15', invoiceNo: 'OLD-2024-001', vendor: 'Jeppesen', desc: '2024 Year End Adjustments', amount: 1500.00, status: 'Paid', currency: 'USD' }
        ];

        // Exchange Rate (Fixed for demo)
        const KRW_RATE = 1450;
        const EUR_TO_USD = 1.05;

        // State
        let currentView = 'table'; // table, vendor, month
        let charts = {};

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateDashboard();
            
            // Period Filter Logic toggle
            document.getElementById('globalPeriodFilter').addEventListener('change', (e) => {
                const monthFilter = document.getElementById('monthFilterContainer');
                if (e.target.value === 'all') {
                    monthFilter.classList.add('hidden');
                } else {
                    // If a specific year is selected, allow month filtering?
                    // Simplified: Just show month filter if Year is selected.
                    // Actually, let's keep it simple: Year Filter affects charts/totals. Month filter refines it.
                    // For now, simple logic: Year selector drives main filter.
                }
                updateDashboard();
            });
        });

        // --- Core Functions ---

        function getFilteredData() {
            const yearFilter = document.getElementById('globalPeriodFilter').value;
            const monthFilter = document.getElementById('globalMonthFilter').value; // Optional enhancement

            return invoices.filter(inv => {
                const invDate = new Date(inv.date);
                const invYear = invDate.getFullYear().toString();
                
                if (yearFilter !== 'all' && invYear !== yearFilter) return false;
                
                // If we implemented month filtering in the top bar:
                // if (monthFilter !== 'all' && (invDate.getMonth() + 1).toString() !== monthFilter) return false;
                
                return true;
            });
        }

        function calculateUSD(amount, currency) {
            if (currency === 'EUR') return amount * EUR_TO_USD;
            return amount;
        }

        function updateDashboard() {
            const data = getFilteredData();
            
            // 1. Calculate Totals
            let totalUSD = 0;
            let pendingUSD = 0;
            let paidCount = 0;
            let pendingCount = 0;

            data.forEach(inv => {
                const usdAmount = calculateUSD(inv.amount, inv.currency);
                totalUSD += usdAmount;
                if (inv.status === 'Pending') {
                    pendingUSD += usdAmount;
                    pendingCount++;
                } else {
                    paidCount++;
                }
            });

            // 2. Update Summary Cards
            animateValue("summaryTotalUSD", totalUSD, "$");
            document.getElementById('summaryTotalKRW').innerText = `₩${(totalUSD * KRW_RATE).toLocaleString(undefined, {maximumFractionDigits:0})}`;
            animateValue("summaryPending", pendingUSD, "$");
            document.getElementById('pendingCount').innerText = `${pendingCount}건 처리 대기중`;
            
            animateValue("summaryPaid", totalUSD - pendingUSD, "$");
            
            const totalCount = paidCount + pendingCount;
            const progress = totalCount === 0 ? 0 : (paidCount / totalCount) * 100;
            document.getElementById('paidProgressBar').style.width = `${progress}%`;

            // This month projection (Simplified: Avg of data * 1)
            const today = new Date();
            const thisMonthData = data.filter(i => new Date(i.date).getMonth() === today.getMonth() && new Date(i.date).getFullYear() === today.getFullYear());
            const thisMonthTotal = thisMonthData.reduce((acc, curr) => acc + calculateUSD(curr.amount, curr.currency), 0);
            animateValue("summaryThisMonth", thisMonthTotal, "$");

            // 3. Update Charts
            updateCharts(data);

            // 4. Update List
            renderInvoiceList();
        }

        // --- Chart Logic ---
        function initCharts() {
            // Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(ctxTrend, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });

            // Vendor Chart
            const ctxVendor = document.getElementById('vendorChart').getContext('2d');
            charts.vendor = new Chart(ctxVendor, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        }

        function updateCharts(data) {
            // Process Trend Data (Monthly)
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = new Array(12).fill(0);
            
            data.forEach(inv => {
                const m = new Date(inv.date).getMonth();
                monthlyData[m] += calculateUSD(inv.amount, inv.currency);
            });

            charts.trend.data = {
                labels: months,
                datasets: [{
                    label: 'Monthly Spend (USD)',
                    data: monthlyData,
                    backgroundColor: '#0ea5e9',
                    borderRadius: 4
                }]
            };
            charts.trend.update();

            // Process Vendor Data
            const vendorMap = {};
            data.forEach(inv => {
                const usd = calculateUSD(inv.amount, inv.currency);
                vendorMap[inv.vendor] = (vendorMap[inv.vendor] || 0) + usd;
            });

            charts.vendor.data = {
                labels: Object.keys(vendorMap),
                datasets: [{
                    data: Object.values(vendorMap),
                    backgroundColor: ['#0369a1', '#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd'],
                    borderWidth: 0
                }]
            };
            charts.vendor.update();
        }

        // --- List View Logic ---

        function setListView(mode) {
            currentView = mode;
            // Update UI Buttons
            ['table', 'vendor', 'month'].forEach(m => {
                const btn = document.getElementById(`btnView${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (m === mode) {
                    btn.classList.remove('text-gray-500', 'bg-transparent');
                    btn.classList.add('bg-white', 'shadow-sm', 'text-gray-800');
                } else {
                    btn.classList.add('text-gray-500', 'bg-transparent');
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-800');
                }
            });

            const tableContainer = document.getElementById('viewTable');
            const groupContainer = document.getElementById('viewGrouped');

            if (mode === 'table') {
                tableContainer.classList.remove('hidden');
                groupContainer.classList.add('hidden');
            } else {
                tableContainer.classList.add('hidden');
                groupContainer.classList.remove('hidden');
            }
            renderInvoiceList();
        }

        function renderInvoiceList() {
            const data = getFilteredData();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = data.filter(item => 
                item.vendor.toLowerCase().includes(searchTerm) || 
                item.invoiceNo.toLowerCase().includes(searchTerm) ||
                item.desc.toLowerCase().includes(searchTerm)
            );

            document.getElementById('recordCount').innerText = `Total ${filteredData.length} records`;

            if (currentView === 'table') {
                renderTable(filteredData);
            } else if (currentView === 'vendor') {
                renderGrouped(filteredData, 'vendor');
            } else if (currentView === 'month') {
                renderGrouped(filteredData, 'month');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('invoiceTableBody');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400">데이터가 없습니다.</td></tr>`;
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0";
                
                const statusClass = item.status === 'Paid' 
                    ? 'bg-green-100 text-green-700 border border-green-200' 
                    : 'bg-red-50 text-red-700 border border-red-100';

                tr.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-gray-600">${item.date}</td>
                    <td class="p-4 text-xs font-mono text-gray-500">${item.invoiceNo}</td>
                    <td class="p-4 font-semibold text-gray-800">${item.vendor}</td>
                    <td class="p-4 text-gray-600 max-w-xs truncate" title="${item.desc}">${item.desc}</td>
                    <td class="p-4 text-right font-mono text-gray-800">
                        ${item.amount.toLocaleString(undefined, {minimumFractionDigits: 2})} 
                        <span class="text-xs text-gray-400 ml-1">${item.currency}</span>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${item.status === 'Paid' ? '결제완료' : '미지급'}</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="openEditModal(${item.id})" class="text-gray-400 hover:text-sky-600 transition-colors p-1" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderGrouped(data, groupBy) {
            const container = document.getElementById('viewGrouped');
            container.innerHTML = '';

            // Grouping Logic
            const groups = {};
            data.forEach(item => {
                let key;
                if (groupBy === 'vendor') key = item.vendor;
                else {
                    const d = new Date(item.date);
                    key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}`;
                }
                
                if (!groups[key]) groups[key] = { items: [], total: 0 };
                groups[key].items.push(item);
                groups[key].total += calculateUSD(item.amount, item.currency);
            });

            // Sort keys
            const sortedKeys = Object.keys(groups).sort();
            if (groupBy === 'month') sortedKeys.reverse(); // Newest months first

            sortedKeys.forEach(key => {
                const group = groups[key];
                const groupDiv = document.createElement('div');
                groupDiv.className = "bg-white border border-gray-200 rounded-lg overflow-hidden";
                
                let headerContent = `
                    <div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer hover:bg-gray-100" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <div class="flex items-center gap-2">
                            <i class="fas ${groupBy === 'vendor' ? 'fa-building' : 'fa-calendar'} text-sky-500"></i>
                            <span class="font-bold text-gray-700">${key}</span>
                            <span class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">${group.items.length}건</span>
                        </div>
                        <span class="font-mono font-bold text-gray-800">$${group.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    </div>
                `;

                let listContent = `<div class="p-0 hidden"><table class="w-full text-sm">`;
                group.items.forEach(item => {
                    listContent += `
                        <tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50">
                            <td class="p-3 pl-8 text-gray-500 w-24">${item.date}</td>
                            <td class="p-3 font-medium">${item.desc}</td>
                            <td class="p-3 text-right w-32">${item.amount.toLocaleString()} ${item.currency}</td>
                            <td class="p-3 w-10 text-center"><button onclick="openEditModal(${item.id})" class="text-xs text-blue-500 hover:underline">Edit</button></td>
                        </tr>
                    `;
                });
                listContent += `</table></div>`;

                groupDiv.innerHTML = headerContent + listContent;
                container.appendChild(groupDiv);
            });
        }

        // --- Edit/Add Logic ---

        function openEditModal(id) {
            const item = invoices.find(i => i.id === id);
            if (!item) return;

            document.getElementById('modalTitle').innerText = "지출 내역 수정";
            document.getElementById('editIndex').value = item.id; // Use ID as key
            document.getElementById('inputDate').value = item.date;
            document.getElementById('inputInvoiceNo').value = item.invoiceNo;
            document.getElementById('inputVendor').value = item.vendor;
            document.getElementById('inputDesc').value = item.desc;
            document.getElementById('inputAmount').value = item.amount;
            document.getElementById('inputStatus').value = item.status;

            document.getElementById('addInvoiceModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('addInvoiceModal').classList.add('hidden');
            // Clear form
            document.getElementById('editIndex').value = '';
            document.getElementById('inputDesc').value = '';
            document.getElementById('inputAmount').value = '';
        }

        function saveInvoice() {
            const id = document.getElementById('editIndex').value;
            const isNew = !id;
            
            const newData = {
                id: isNew ? Date.now() : parseInt(id),
                date: document.getElementById('inputDate').value,
                invoiceNo: document.getElementById('inputInvoiceNo').value,
                vendor: document.getElementById('inputVendor').value,
                desc: document.getElementById('inputDesc').value,
                amount: parseFloat(document.getElementById('inputAmount').value),
                status: document.getElementById('inputStatus').value,
                currency: 'USD' // Defaulting to USD for edit simplicity, in real app add currency selector
            };

            if (!newData.date || !newData.amount) return alert("날짜와 금액을 입력해주세요.");

            if (isNew) {
                invoices.push(newData);
            } else {
                const index = invoices.findIndex(i => i.id === parseInt(id));
                if (index !== -1) invoices[index] = newData;
            }

            closeModal();
            updateDashboard(); // Refreshes everything
        }

        // --- Utilities ---
        function animateValue(id, end, prefix = "") {
            const obj = document.getElementById(id);
            // Simple update for responsiveness
            obj.innerHTML = prefix + end.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            // In a full SPA, this would toggle visibility of main sections.
            // For this demo, we focus on the Dashboard/Invoice view.
            if(tab !== 'dashboard' && tab !== 'invoices') alert("데모 버전에서는 대시보드 및 지출 관리 페이지만 제공됩니다.");
        }
        
        function exportToExcel() {
             const data = getFilteredData().map(i => ({
                 Date: i.date,
                 InvoiceNo: i.invoiceNo,
                 Vendor: i.vendor,
                 Description: i.desc,
                 Amount: i.amount,
                 Currency: i.currency,
                 Status: i.status
             }));
             
             const ws = XLSX.utils.json_to_sheet(data);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Expenses");
             XLSX.writeFile(wb, `Parata_Expenses_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

    </script>
</body>
</html>
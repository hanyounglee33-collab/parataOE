<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parata Air Operation Tech Team Accounting System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; overflow-x: hidden; color: #1e293b; }
        .sidebar { width: 280px; height: 100vh; position: fixed; right: 0; top: 0; background: #0f172a; color: white; z-index: 50; }
        .main-content { margin-right: 280px; padding: 2.5rem; min-height: 100vh; }
        .card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1rem; }
        
        .view-content { display: none; }
        .view-active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1024px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-right: 0; padding: 1.5rem; }
        }

        @media print {
            .sidebar, .no-print { display: none !important; }
            .main-content { margin-right: 0; padding: 0; }
            .view-content { display: block !important; }
        }
    </style>
</head>
<body>

    <main class="main-content">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start gap-4 no-print">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">ìš´í•­ ê¸°ìˆ íŒ€ íšŒê³„ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p class="text-slate-500 font-medium tracking-wide">Parata Air Operation Tech Team Accounting</p>
            </div>
            
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wider text-center">ê¸°ì¤€ í™˜ìœ¨ ì„¤ì •</h4>
                <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] text-slate-400 mb-1">USD/KRW</span>
                        <input type="number" id="rateUsd" value="1350" oninput="handleRateChange()" class="text-sm font-bold w-20 text-center border-b-2 border-slate-100 focus:border-blue-500 outline-none">
                    </div>
                    <div class="flex flex-col items-center border-l pl-4 border-slate-100">
                        <span class="text-[10px] text-slate-400 mb-1">EUR/KRW</span>
                        <input type="number" id="rateEur" value="1450" oninput="handleRateChange()" class="text-sm font-bold w-20 text-center border-b-2 border-slate-100 focus:border-blue-500 outline-none">
                    </div>
                </div>
            </div>
        </header>

        <!-- [VIEW 1] Dashboard & Entry -->
        <div id="view-dashboard" class="view-content view-active space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="card p-6 border-t-4 border-blue-600">
                    <p class="text-[11px] font-bold text-slate-400 uppercase">ì´ ì§‘í–‰ í•©ê³„ (KRW)</p>
                    <h3 id="dashTotal" class="text-2xl font-black mt-1">0 ì›</h3>
                </div>
                <div class="card p-6 border-t-4 border-emerald-500">
                    <p class="text-[11px] font-bold text-slate-400 uppercase">ì§€ê¸‰ ì™„ë£Œ (KRW)</p>
                    <h3 id="dashPaid" class="text-2xl font-black text-emerald-600 mt-1">0 ì›</h3>
                </div>
                <div class="card p-6 border-t-4 border-rose-500">
                    <p class="text-[11px] font-bold text-slate-400 uppercase">ë¯¸ì§€ê¸‰ ì”ì•¡ (KRW)</p>
                    <h3 id="dashUnpaid" class="text-2xl font-black text-rose-600 mt-1">0 ì›</h3>
                </div>
                <div class="card p-6 border-t-4 border-amber-500">
                    <p class="text-[11px] font-bold text-slate-400 uppercase">ì´ í•©ê³„ (USD í™˜ì‚°)</p>
                    <h3 id="dashTotalUsd" class="text-2xl font-black text-amber-600 mt-1">$ 0.00</h3>
                </div>
            </div>

            <!-- Entry Form -->
            <section class="no-print">
                <div class="card p-8 shadow-lg">
                    <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
                        <div class="w-1.5 h-5 bg-blue-600 rounded-full"></div>
                        ì¸ë³´ì´ìŠ¤ ë°ì´í„° ì…ë ¥ (Entry)
                    </h2>
                    <form id="accountingForm" class="space-y-6">
                        <div class="input-grid">
                            <!-- ê³µê¸‰ì—…ì²´ -->
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">ê³µê¸‰ì—…ì²´ (Vendor)</label>
                                <select id="vendorSelect" required onchange="toggleDirectInput('vendorSelect', 'vendorDirect')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                                    <option value="">ì—…ì²´ ì„ íƒ</option>
                                    <option value="Honeywell">Honeywell</option>
                                    <option value="Navblue">Navblue</option>
                                    <option value="Jeppesen">Jeppesen</option>
                                    <option value="Airbus">Airbus</option>
                                    <option value="direct">ì§ì ‘ ì…ë ¥</option>
                                </select>
                                <input type="text" id="vendorDirect" placeholder="ì—…ì²´ëª… ì…ë ¥" class="hidden mt-2 w-full p-3 bg-white border border-blue-300 rounded-xl text-sm outline-none shadow-sm">
                            </div>

                            <!-- ê¸ˆì•¡ & í†µí™” -->
                            <div class="col-span-1 md:col-span-2 flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-[11px] font-bold text-slate-400 mb-2">ê¸ˆì•¡ (Amount)</label>
                                    <input type="number" id="inputAmount" step="any" placeholder="0" required oninput="calculatePreview()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                                </div>
                                <div class="w-24">
                                    <label class="block text-[11px] font-bold text-slate-400 mb-2">í†µí™”</label>
                                    <select id="currency" onchange="calculatePreview()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500">
                                        <option value="KRW">KRW</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label class="block text-[11px] font-bold text-blue-600 mb-2 uppercase">USD í™˜ì‚° (ë¯¸ë¦¬ë³´ê¸°)</label>
                                    <input type="text" id="previewUsd" placeholder="$ 0.00" readonly class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-700 font-bold outline-none cursor-not-allowed">
                                </div>
                            </div>

                            <!-- ì¸ë³´ì´ìŠ¤ ë²ˆí˜¸ -->
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">Invoice No.</label>
                                <input type="text" id="invoiceNo" placeholder="INV-000" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                            </div>

                            <!-- ê¸°ì•ˆì -->
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">ê¸°ì•ˆì (Drafter)</label>
                                <select id="drafterSelect" required onchange="toggleDirectInput('drafterSelect', 'drafterDirect')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                                    <option value="">ê¸°ì•ˆì ì„ íƒ</option>
                                    <option value="ì´ìœ¨ë¹„">ì´ìœ¨ë¹„</option>
                                    <option value="ë°•ì •ì›">ë°•ì •ì›</option>
                                    <option value="ë„ì¬ìœ¤">ë„ì¬ìœ¤</option>
                                    <option value="ë°•ë‚¨ì¤€">ë°•ë‚¨ì¤€</option>
                                    <option value="ì´ì¢…í—Œ">ì´ì¢…í—Œ</option>
                                    <option value="direct">ì§ì ‘ ì…ë ¥</option>
                                </select>
                                <input type="text" id="drafterDirect" placeholder="ì„±í•¨ ì…ë ¥" class="hidden mt-2 w-full p-3 bg-white border border-blue-300 rounded-xl text-sm outline-none shadow-sm">
                            </div>

                            <!-- ì¼ì -->
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">ì¸ë³´ì´ìŠ¤ ì¼ì</label>
                                <input type="date" id="invoiceDate" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                            </div>

                            <!-- ì§€ê¸‰ì—¬ë¶€ -->
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">ì§€ê¸‰ ìƒíƒœ</label>
                                <select id="isPaid" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                                    <option value="false">ë¯¸ì§€ê¸‰</option>
                                    <option value="true">ì§€ê¸‰ì™„ë£Œ</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-[11px] font-bold text-slate-400 mb-2">ë¹„ê³  (Remarks)</label>
                                <input type="text" id="remarks" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 transition-all">
                            </div>
                            <button type="submit" class="bg-slate-900 text-white px-10 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all shadow-lg active:scale-95 h-[46px]">ë°ì´í„° ì €ì¥</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Table List with Filter -->
            <div class="card overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-white gap-4">
                    <h2 class="text-lg font-bold text-slate-800">ì§€ì¶œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ (Audit List)</h2>
                    <div class="flex flex-wrap items-center gap-3 no-print">
                        <div class="flex items-center gap-2">
                            <input type="date" id="exportStart" class="p-2 border border-slate-200 rounded-lg text-xs outline-none">
                            <span class="text-slate-400">~</span>
                            <input type="date" id="exportEnd" class="p-2 border border-slate-200 rounded-lg text-xs outline-none">
                        </div>
                        <button onclick="exportToExcel()" class="text-xs bg-emerald-50 text-emerald-700 border border-emerald-200 px-4 py-2 rounded-lg font-bold hover:bg-emerald-100 transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            ê¸°ê°„ ì„ íƒ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-400 border-b border-slate-200">
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">ì¼ì</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">Inv No.</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">ì—…ì²´ëª…</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest text-center">ê¸°ì•ˆì</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">ê¸ˆì•¡ (Original)</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">KRW í™˜ì‚°</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">USD í™˜ì‚°</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest text-center">ìƒíƒœ</th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest">ë¹„ê³ </th>
                                <th class="p-4 font-bold uppercase text-[10px] tracking-widest text-center no-print">ì‚­ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                    <div id="noDataMessage" class="p-20 text-center text-slate-400 italic font-medium hidden">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <!-- [VIEW 2] Infographic Visual Report with Filters -->
        <div id="view-report" class="view-content space-y-8">
            <div class="flex justify-between items-end no-print">
                <div>
                    <h2 class="text-3xl font-black text-slate-900">íšŒê³„ ì¸í¬ê·¸ë˜í”½ ë³´ê³ ì„œ</h2>
                    <p class="text-slate-500">ë¶„ì„ ì¡°ê±´ì— ë”°ë¥¸ ì‹œê°í™” ë°ì´í„°</p>
                </div>
                <button onclick="window.print()" class="bg-slate-900 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-600 transition">PDF ì¶œë ¥ / ì €ì¥</button>
            </div>

            <!-- Report Filters -->
            <div class="card p-6 no-print bg-slate-50 border-blue-100 border-2">
                <div class="flex flex-wrap items-end gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">ë¶„ì„ ê¸°ê°„ ì„¤ì •</label>
                        <div class="flex items-center gap-2">
                            <input type="date" id="reportStart" onchange="updateCharts()" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500">
                            <span class="text-slate-300">~</span>
                            <input type="date" id="reportEnd" onchange="updateCharts()" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">ì—…ì²´ ì„ íƒ í•„í„°</label>
                        <select id="reportVendorFilter" onchange="updateCharts()" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none min-w-[180px] focus:border-blue-500">
                            <option value="all">ì „ì²´ ì—…ì²´ ë¶„ì„</option>
                            <option value="Honeywell">Honeywell</option>
                            <option value="Navblue">Navblue</option>
                            <option value="Jeppesen">Jeppesen</option>
                            <option value="Airbus">Airbus</option>
                            <!-- ë™ì  ì¶”ê°€ë  ê¸°íƒ€ ì—…ì²´ë“¤ -->
                        </select>
                    </div>
                    <div class="flex-1 text-right">
                        <button onclick="resetReportFilters()" class="text-xs text-slate-400 hover:text-blue-500 font-bold underline transition">í•„í„° ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-8 flex flex-col items-center"><h3 class="text-sm font-bold text-slate-400 mb-6 uppercase">ì—…ì²´ë³„ ì§€ì¶œ ë¹„ì¤‘</h3><div class="h-[320px] w-full"><canvas id="vendorChart"></canvas></div></div>
                <div class="card p-8 flex flex-col items-center"><h3 class="text-sm font-bold text-slate-400 mb-6 uppercase">ì›”ë³„ ì§€ì¶œ ì¶”ì´</h3><div class="h-[320px] w-full"><canvas id="monthlyChart"></canvas></div></div>
                <div class="card p-8 flex flex-col items-center"><h3 class="text-sm font-bold text-slate-400 mb-6 uppercase">ì§€ê¸‰ ìƒíƒœ ìš”ì•½</h3><div class="h-[320px] w-full"><canvas id="statusChart"></canvas></div></div>
                <div class="bg-slate-900 text-white p-10 rounded-3xl shadow-2xl flex flex-col justify-center">
                    <h3 class="text-2xl font-black mb-6 text-blue-400">ğŸ“Š í•„í„°ë§ëœ ë°ì´í„° í†µê³„</h3>
                    <ul id="insights-list" class="space-y-4 text-slate-300 font-medium"></ul>
                </div>
            </div>
        </div>

        <!-- [VIEW 3] Settings -->
        <div id="view-settings" class="view-content space-y-8">
            <h2 class="text-3xl font-black text-slate-900 tracking-tight">ì‹œìŠ¤í…œ ì„¤ì • ë° ë°±ì—…</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="text-lg font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3>
                    <div class="space-y-3">
                        <button onclick="downloadBackup()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition">ë°±ì—… íŒŒì¼(.json) ë‹¤ìš´ë¡œë“œ</button>
                        <label class="w-full py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold hover:bg-slate-200 transition text-center cursor-pointer border-2 border-dashed border-slate-300 block">
                            ë³µêµ¬ (íŒŒì¼ ì„ íƒ)
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                        </label>
                    </div>
                </div>
                <div class="card p-8 bg-slate-50 border-none font-mono text-xs">
                    <h3 class="text-lg font-bold mb-4 text-slate-700">Storage Information</h3>
                    <p class="text-slate-500">Database Engine: <span class="text-blue-600 font-bold">LocalStorage (parata_v15_final)</span></p>
                    <p class="mt-4 leading-relaxed">ì´ ì‹œìŠ¤í…œì€ ë°ì´í„° ì•ˆì •ì„±ì„ ìœ„í•´ ëª¨ë“  ì…ë ¥ì„ ì¦‰ì‹œ ë¸Œë¼ìš°ì €ì— ì»¤ë°‹í•©ë‹ˆë‹¤. ì£¼ê¸°ì ì¸ JSON ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Sidebar Menu (Right) -->
    <aside class="sidebar p-8 flex flex-col shadow-2xl no-print">
        <div class="mb-12 text-center">
            <div class="text-2xl font-black tracking-tighter text-blue-400 uppercase">Parata Air</div>
            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Accounting Management</div>
            <div class="h-1 w-10 bg-blue-600 mx-auto mt-4 rounded-full"></div>
        </div>

        <nav class="flex-1 space-y-4">
            <button onclick="switchView('view-dashboard')" id="nav-dashboard" class="nav-btn w-full p-4 rounded-2xl flex items-center gap-3 transition-all text-slate-400">
                <span class="text-sm font-bold">ì¸ë³´ì´ìŠ¤ ì…ë ¥ & ê´€ë¦¬</span>
            </button>
            <button onclick="switchView('view-report')" id="nav-report" class="nav-btn w-full p-4 rounded-2xl flex items-center gap-3 transition-all text-slate-400">
                <span class="text-sm font-bold">ì¸í¬ê·¸ë˜í”½ ë¦¬í¬íŠ¸</span>
            </button>
            <button onclick="switchView('view-settings')" id="nav-settings" class="nav-btn w-full p-4 rounded-2xl flex items-center gap-3 transition-all text-slate-400">
                <span class="text-sm font-bold">ë°ì´í„° ì„¤ì • & ë°±ì—…</span>
            </button>
        </nav>

        <div class="mt-auto pt-6 border-t border-slate-800">
            <button onclick="showResetModal()" class="w-full p-4 rounded-2xl border border-rose-500/30 text-rose-400 text-xs font-bold hover:bg-rose-500 hover:text-white transition-all uppercase tracking-tighter">
                ì „ì²´ ì´ˆê¸°í™”
            </button>
        </div>
    </aside>

    <!-- Modal -->
    <div id="resetModal" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center z-[100] backdrop-blur-md no-print p-4">
        <div class="bg-white p-10 rounded-[2rem] max-w-sm w-full text-center">
            <h3 class="text-2xl font-black text-slate-900 mb-2">ë°ì´í„° ì´ˆê¸°í™”</h3>
            <p class="text-slate-500 mb-8">ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë˜ë©° ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold">ì·¨ì†Œ</button>
                <button onclick="confirmReset()" class="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-bold">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'parata_v15_final';
        let invoices = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let activeView = 'view-dashboard';
        let charts = { vendor: null, monthly: null, status: null };

        document.addEventListener('DOMContentLoaded', () => {
            syncAndRender();
            switchView('view-dashboard');
        });

        function switchView(viewId) {
            activeView = viewId;
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('view-active'));
            document.getElementById(viewId).classList.add('view-active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-xl');
                btn.classList.add('text-slate-400', 'hover:bg-slate-800');
            });
            const activeNav = document.getElementById('nav-' + viewId.split('-')[1]);
            if (activeNav) {
                activeNav.classList.add('bg-blue-600', 'text-white', 'shadow-xl');
                activeNav.classList.remove('text-slate-400', 'hover:bg-slate-800');
            }
            if (viewId === 'view-report') {
                updateVendorFilterList();
                updateCharts();
            }
        }

        function toggleDirectInput(selectId, inputId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (select.value === 'direct') {
                input.classList.remove('hidden');
                input.required = true;
            } else {
                input.classList.add('hidden');
                input.required = false;
            }
        }

        function calculatePreview() {
            const amount = parseFloat(document.getElementById('inputAmount').value) || 0;
            const currency = document.getElementById('currency').value;
            const rateUsd = parseFloat(document.getElementById('rateUsd').value) || 1350;
            const rateEur = parseFloat(document.getElementById('rateEur').value) || 1450;
            const preview = document.getElementById('previewUsd');
            let res = 0;
            if (currency === 'KRW') res = amount / rateUsd;
            else if (currency === 'USD') res = amount;
            else if (currency === 'EUR') res = (amount * rateEur) / rateUsd;
            preview.value = amount > 0 ? `$ ${res.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '';
        }

        function handleRateChange() { calculatePreview(); syncAndRender(); }

        document.getElementById('accountingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('inputAmount').value) || 0;
            const curr = document.getElementById('currency').value;
            const rUsd = parseFloat(document.getElementById('rateUsd').value) || 1350;
            const rEur = parseFloat(document.getElementById('rateEur').value) || 1450;

            let krw = 0, usd = 0;
            if (curr === 'KRW') { krw = amount; usd = amount / rUsd; }
            else if (curr === 'USD') { krw = amount * rUsd; usd = amount; }
            else if (curr === 'EUR') { krw = amount * rEur; usd = krw / rUsd; }

            const vSelect = document.getElementById('vendorSelect');
            const vendor = vSelect.value === 'direct' ? document.getElementById('vendorDirect').value : vSelect.value;
            
            const dSelect = document.getElementById('drafterSelect');
            const drafter = dSelect.value === 'direct' ? document.getElementById('drafterDirect').value : dSelect.value;

            const entry = {
                id: Date.now(),
                invoiceDate: document.getElementById('invoiceDate').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                vendor: vendor || 'Unknown',
                originalAmount: amount,
                originalCurrency: curr,
                amountKrw: Math.round(krw),
                amountUsd: usd,
                drafter: drafter || 'Unknown',
                isPaid: document.getElementById('isPaid').value === 'true',
                remarks: document.getElementById('remarks').value
            };

            invoices.push(entry);
            syncAndRender();
            e.target.reset();
            document.getElementById('vendorDirect').classList.add('hidden');
            document.getElementById('drafterDirect').classList.add('hidden');
            document.getElementById('previewUsd').value = '';
        });

        function syncAndRender() {
            localStorage.setItem(DB_KEY, JSON.stringify(invoices));
            updateStats();
            renderTable();
            if (activeView === 'view-report') updateCharts();
        }

        function updateStats() {
            const tK = invoices.reduce((s, i) => s + i.amountKrw, 0);
            const pK = invoices.filter(i => i.isPaid).reduce((s, i) => s + i.amountKrw, 0);
            const tU = invoices.reduce((s, i) => s + i.amountUsd, 0);
            document.getElementById('dashTotal').innerText = tK.toLocaleString() + " ì›";
            document.getElementById('dashPaid').innerText = pK.toLocaleString() + " ì›";
            document.getElementById('dashUnpaid').innerText = (tK - pK).toLocaleString() + " ì›";
            document.getElementById('dashTotalUsd').innerText = `$ ${tU.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        }

        function renderTable() {
            const list = document.getElementById('reportTableBody');
            const noData = document.getElementById('noDataMessage');
            if (invoices.length === 0) { list.innerHTML = ''; noData.classList.remove('hidden'); return; }
            noData.classList.add('hidden');
            const sorted = [...invoices].sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));
            list.innerHTML = sorted.map(inv => `
                <tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors">
                    <td class="p-4 font-bold text-slate-700">${inv.invoiceDate || '-'}</td>
                    <td class="p-4 font-mono text-[11px] text-slate-400">${inv.invoiceNo || '-'}</td>
                    <td class="p-4 font-black text-slate-900">${inv.vendor}</td>
                    <td class="p-4 text-center font-bold text-slate-600 text-xs">${inv.drafter}</td>
                    <td class="p-4 font-medium text-slate-500 whitespace-nowrap">${inv.originalAmount.toLocaleString()} ${inv.originalCurrency}</td>
                    <td class="p-4 font-bold text-blue-700">${inv.amountKrw.toLocaleString()}</td>
                    <td class="p-4 font-bold text-amber-600">$ ${inv.amountUsd.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="p-4 text-center">
                        <button onclick="togglePaid(${inv.id})" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${inv.isPaid ? 'bg-emerald-500 text-white shadow-md' : 'bg-rose-100 text-rose-600'}">
                            ${inv.isPaid ? 'ì§€ê¸‰ì™„ë£Œ' : 'ë¯¸ì§€ê¸‰'}
                        </button>
                    </td>
                    <td class="p-4 text-xs text-slate-500 max-w-[150px] break-words">${inv.remarks || '-'}</td>
                    <td class="p-4 text-center no-print">
                        <button onclick="deleteItem(${inv.id})" class="text-slate-300 hover:text-rose-500 transition-colors p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteItem(id) { invoices = invoices.filter(i => i.id !== id); syncAndRender(); }
        function togglePaid(id) { const i = invoices.find(x => x.id === id); i.isPaid = !i.isPaid; syncAndRender(); }

        // Infographics with Filter
        function updateVendorFilterList() {
            const filterSelect = document.getElementById('reportVendorFilter');
            const currentVal = filterSelect.value;
            const uniqueVendors = [...new Set(invoices.map(i => i.vendor))].sort();
            
            let options = '<option value="all">ì „ì²´ ì—…ì²´ ë¶„ì„</option>';
            uniqueVendors.forEach(v => {
                options += `<option value="${v}" ${currentVal === v ? 'selected' : ''}>${v}</option>`;
            });
            filterSelect.innerHTML = options;
        }

        function resetReportFilters() {
            document.getElementById('reportStart').value = '';
            document.getElementById('reportEnd').value = '';
            document.getElementById('reportVendorFilter').value = 'all';
            updateCharts();
        }

        function updateCharts() {
            const start = document.getElementById('reportStart').value;
            const end = document.getElementById('reportEnd').value;
            const vendorFilter = document.getElementById('reportVendorFilter').value;

            let filteredInvoices = invoices;
            if (start) filteredInvoices = filteredInvoices.filter(i => i.invoiceDate >= start);
            if (end) filteredInvoices = filteredInvoices.filter(i => i.invoiceDate <= end);
            if (vendorFilter !== 'all') filteredInvoices = filteredInvoices.filter(i => i.vendor === vendorFilter);

            if (filteredInvoices.length === 0) {
                clearCharts();
                document.getElementById('insights-list').innerHTML = '<li class="text-rose-400">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</li>';
                return;
            }

            const vSum = {}; const mSum = {};
            filteredInvoices.forEach(i => {
                vSum[i.vendor] = (vSum[i.vendor] || 0) + i.amountKrw;
                const m = i.invoiceDate.substring(0, 7); if(m) mSum[m] = (mSum[m] || 0) + i.amountKrw;
            });
            const pCount = filteredInvoices.filter(i => i.isPaid).length;

            if (charts.vendor) charts.vendor.destroy();
            charts.vendor = new Chart(document.getElementById('vendorChart'), { type:'doughnut', data:{ labels:Object.keys(vSum), datasets:[{data:Object.values(vSum), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}});

            if (charts.monthly) charts.monthly.destroy();
            const sM = Object.keys(mSum).sort();
            charts.monthly = new Chart(document.getElementById('monthlyChart'), { type:'bar', data:{ labels:sM, datasets:[{label:'ì§€ì¶œì•¡(KRW)', data:sM.map(m=>mSum[m]), backgroundColor:'#10b981', borderRadius:8}]}, options:{responsive:true, maintainAspectRatio:false}});

            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart'), { type:'pie', data:{ labels:['ì™„ë£Œ','ë¯¸ì§€ê¸‰'], datasets:[{data:[pCount, filteredInvoices.length - pCount], backgroundColor:['#10b981','#f43f5e']}]}, options:{responsive:true, maintainAspectRatio:false}});

            const topV = Object.entries(vSum).sort((a,b)=>b[1]-a[1])[0];
            document.getElementById('insights-list').innerHTML = `
                <li class="flex gap-2"><span>âœ…</span> í•„í„° ë²”ìœ„ ë‚´ ì§€ì¶œ 1ìœ„: <b>${topV ? topV[0] : '-'}</b></li>
                <li class="flex gap-2"><span>âœ…</span> í•„í„° ë²”ìœ„ ë‚´ ë¯¸ì§€ê¸‰ ê±´ìˆ˜: <b class="text-rose-400">${filteredInvoices.length - pCount}ê±´</b></li>
                <li class="flex gap-2"><span>âœ…</span> í•„í„° ë²”ìœ„ ë‚´ ì´ì•¡: <b>${filteredInvoices.reduce((a,b)=>a+b.amountKrw,0).toLocaleString()}ì›</b></li>
            `;
        }

        function clearCharts() {
            if (charts.vendor) charts.vendor.destroy();
            if (charts.monthly) charts.monthly.destroy();
            if (charts.status) charts.status.destroy();
        }

        // Utils
        function exportToExcel() {
            const start = document.getElementById('exportStart').value;
            const end = document.getElementById('exportEnd').value;
            
            let exportData = invoices;
            if (start) exportData = exportData.filter(i => i.invoiceDate >= start);
            if (end) exportData = exportData.filter(i => i.invoiceDate <= end);

            if (exportData.length === 0) {
                alert("í•´ë‹¹ ê¸°ê°„ì— ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const data = exportData.map(i => ({ì¼ì:i.invoiceDate, No:i.invoiceNo, ì—…ì²´:i.vendor, ê¸°ì•ˆì:i.drafter, ì›ë³¸ê¸ˆì•¡:i.originalAmount, í†µí™”:i.originalCurrency, KRWí™˜ì‚°:i.amountKrw, USDí™˜ì‚°:i.amountUsd, ìƒíƒœ:i.isPaid?'ì™„ë£Œ':'ë¯¸ì§€ê¸‰', ë¹„ê³ :i.remarks}));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ParataReport");
            const fileName = `Parata_Accounting_${start || 'Start'}~${end || 'End'}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function downloadBackup() {
            const data = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(invoices));
            const a = document.createElement('a'); a.href = data; a.download = `Parata_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function importData(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => { 
                try { invoices = JSON.parse(ev.target.result); syncAndRender(); alert("ë³µêµ¬ ì™„ë£Œ"); } 
                catch(e) { alert("íŒŒì¼ ì˜¤ë¥˜"); }
            }; r.readAsText(f);
        }

        function showResetModal() { document.getElementById('resetModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('resetModal').classList.add('hidden'); }
        function confirmReset() { invoices = []; syncAndRender(); closeModal(); }
    </script>
</body>
</html>